{% extends 'base.html' %}

{% block content %}
<div class="card p-4" style="background-color: #2b2b2b; border: 1px solid #444;">
  <div class="container">
    <div class="register-container flex-fill">
      <div class="register-card">
        <div class="card-header">
          <h2>Create Account</h2>
          <p style="color: white;">Enter your details to register</p>
        </div>

        {% if message %}
        <div class="alert {% if 'exists' in message %}alert-error{% else %}alert-success{% endif %}">
          <span class="alert-icon">{% if 'exists' in message %}✅{% else %}❎{% endif %}</span>
          <span class="alert-text">{{ message }}</span>
        </div>
        {% endif %}

        <form action="{{ url_for('register') }}" method="POST">
          <div class="form-group">
            <label for="name" style="color: white;">Name</label>
            <input type="text" id="name" name="name" class="form-control" placeholder="Enter your name" required>
          </div>
          <div class="form-group">
            <label for="username" style="color: white;">Username</label>
            <input type="text" id="username" name="username" class="form-control" placeholder="Enter your username" required>
          </div>
          <div class="form-group">
            <label for="password" style="color: white;">Password</label>
            <input type="password" id="password" name="password" class="form-control" placeholder="Enter your password" required>
          </div>
          <div class="form-group">
            <label for="confirm_password" style="color: white;">Confirm Password</label>
            <input type="password" id="confirm_password" name="confirm_password" class="form-control" placeholder="Confirm your password" required>
          </div>
          <input type="hidden" name="instructor" value="instructor" />
          <button type="submit" class="btn btn-primary mt-3">
            Create Account <i class="fas fa-arrow-right"></i>
          </button>
        </form>
      </div>
    </div>

    <!-- Button to trigger account modal -->
    <button class="btn btn-secondary mt-4" data-bs-toggle="modal" data-bs-target="#accountsModal">
      <i class="fas fa-users"></i> View Registered Accounts
    </button>

    <!-- Registered Accounts Modal - Fixed version -->
    <div class="modal fade" id="accountsModal" tabindex="-1" aria-labelledby="accountsModalLabel" aria-hidden="true" style="z-index: 1050;">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background-color: #2e2e2e; color: white;">
          <div class="modal-header border-0">
            <h5 class="modal-title" id="accountsModalLabel">Registered Accounts</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <table class="table table-dark table-bordered table-hover">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Username</th>
                  <th>Password</th>
                  <th>Date Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for account in accounts %}
                <tr>
                  <td>{{ account.name }}</td>
                  <td>{{ account.username }}</td>
                  <td>{{ account.password }}</td>
                  <td>{{ account.time_created }}</td>
                  <td>
                    <button class="btn btn-sm btn-warning open-edit-modal"
                            data-username="{{ account.username }}"
                            data-password="{{ account.password }}"
                            onclick="openEditModal('{{ account.username }}')">
                      Edit
                    </button>
                    <form method="POST" action="{{ url_for('register') }}" class="d-inline">
                      <input type="hidden" name="action" value="delete">
                      <input type="hidden" name="username" value="{{ account.username }}">
                      <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                    </form>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="modal-footer border-0">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close & Return to Register</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Password Modal - Fixed version -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true" style="z-index: 1060;">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: #2e2e2e; color: white;">
          <form method="POST" action="{{ url_for('register') }}">
            <div class="modal-header">
              <h5 class="modal-title" id="editModalLabel">Update Password</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="action" value="edit">
              <input type="hidden" id="edit-username" name="username">
              <div class="mb-3">
                <label for="new_password" class="form-label">New Password</label>
                <input type="password" name="new_password" class="form-control" required>
              </div>
              <div class="mb-3">
                <label for="confirm_new_password" class="form-label">Confirm New Password</label>
                <input type="password" name="confirm_new_password" class="form-control" required>
              </div>
            </div>
            <div class="modal-footer border-0">
              <button type="submit" class="btn btn-success">Save</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel & Return to Register</button>
            </div>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- CSS fixes -->
<style>
  /* Fix modal interaction issues */
  .modal {
    pointer-events: auto !important;
  }
  
  .modal-backdrop {
    z-index: 1040 !important;
  }
  
  .modal-content {
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
  }
  
  /* Ensure modal buttons are clickable */
  .modal button, .modal a {
    position: relative;
    z-index: 1;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize Bootstrap modals properly
  var modals = document.querySelectorAll('.modal');
  modals.forEach(function(modalEl) {
    var modal = new bootstrap.Modal(modalEl);
  });
  
  // Function to open edit modal with correct username
  window.openEditModal = function(username) {
    document.getElementById('edit-username').value = username;
    var editModal = new bootstrap.Modal(document.getElementById('editModal'));
    editModal.show();
  };
  
  // Close accounts modal when edit modal is opened
  document.querySelectorAll('.open-edit-modal').forEach(button => {
    button.addEventListener('click', function() {
      var accountsModal = bootstrap.Modal.getInstance(document.getElementById('accountsModal'));
      if (accountsModal) {
        accountsModal.hide();
      }
    });
  });

  // Password confirmation validation for registration
  document.querySelector('form').addEventListener('submit', function(e) {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    if (password !== confirmPassword) {
      e.preventDefault();
      alert('Passwords do not match!');
    }
  });

  // Password confirmation validation for edit modal
  document.querySelector('#editModal form').addEventListener('submit', function(e) {
    const newPassword = this.querySelector('input[name="new_password"]').value;
    const confirmNewPassword = this.querySelector('input[name="confirm_new_password"]').value;
    
    if (newPassword !== confirmNewPassword) {
      e.preventDefault();
      alert('New passwords do not match!');
    }
  });
  
  // Ensure all modal close buttons work properly
  document.querySelectorAll('[data-bs-dismiss="modal"]').forEach(button => {
    button.addEventListener('click', function() {
      const modalId = this.closest('.modal').id;
      const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
      if (modal) modal.hide();
    });
  });
});
</script>
{% endblock %}
